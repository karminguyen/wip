<!doctype html>
<html manifest="/JavaScript/Fortnox_API_test/fortnox.appcache">

  <head>
    <title>Offline webapp</title>


    <!-- Bootstrap -->
    <link href="/lib/css/bootstrap-combined.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>

  <body>

    <div class="container">

      <!-- Top row with menu -->
      <div class="row">
        <div class="span12">

          <!-- The menu used to show different templates -->
          <div id="menu">
            Menu:
            <a href="#route1">#screen1</a> 
            <a href="#route2">#screen2</a> 
            <a href="#route3">#screen3</a>
          </div>

        </div> <!-- /span12 -->
      </div> <!-- /row -->

      <!-- Second row with content -->
      <div class="row">

        <!-- Left column with the UI -->
        <div class="span8">

          <!-- Templates are rendered here -->
          <div id="ui">
          </div>

        </div> <!-- /span8 -->


        <!-- Left column with some settings -->
        <div class="span4">
          <form>
            <fieldset>
              <legend>Settings</legend>

              <span class="help-block">These settings are stored locally on your laptop and nowhere else. The 
                calls to Fortnox are made with HTTPS so your credentials are safe.</span>

              <label>Databas</label>
              <input id="database_id" type="text" placeholder="Your Fortnox database id">
              <span class="help-block">Your Database id is showed in Administration in the Lobby in Fortnox.</span>

              <label>API Token</label>
              <input id="api_token" type="text" placeholder="Your Fortnox token">
              <span class="help-block">Your token is showed in Administration in the Lobby in Fortnox.</span>

            </fieldset>
          </form>


        </div> <!-- /span4 -->
      </div> <!-- /row -->

 
      <!-- Bottom row with tests etc. -->
      <div class="row">
        <div class="span12">
 
          <!-- Show test results -->
          <ul id="results"></ul>

        </div> <!-- /span12 -->
      </div> <!-- /row -->

    </div> <!-- /container -->


    <!-- Templates -->

    <script type="text/template" id="template1">
      <h3>This is screen 1</h3>
    </script>

    <script type="text/template" id="template2">
      <h3>This is screen 2</h3>
    </script>

    <script type="text/template" id="template3">
      <h3>This is screen 3</h3>
    </script>



    <!-- Scripts at the end for better performance -->

    <script src="/lib/js/jquery.min.js"></script>
    <script src="/lib/js/bootstrap.min.js"></script>
    <script src="/lib/js/persona-include.js"></script>
    <script src="/lib/js/modernizr-build.min.js"></script>

    <script src="/lib/js/helpers-1.0.js"></script>
    <script src="/lib/js/signals.js"></script>
    <script src="/lib/js/crossroads.min.js"></script>
    <script src="/lib/js/hasher.min.js"></script>
    <script src="/lib/js/plates.js"></script>

    <script src="js/view.js"></script>
    <script src="js/controller.js"></script>
    <script src="js/model.js"></script>

    <script type="text/javascript">

    // Design overviw
    //=========================================================
    //
    // The stapesjs micro MVC library is used. 
    //
    // A publish/subscribe model is used
    //----------------------------------------------------------------
    //
    // | Event          | Publishers     | Subscribers    |
    // |----------------|----------------|----------------|
    // |                |                |                |
    //
    //
    // DOM objects:
    //----------------------------------------------------------------
    // | Object         | Event          | Notes          |
    // |----------------|----------------|----------------|
    // | Window         |                |                |
    // | database_id    |                | input          |
    // | api_token      |                | input          |
    //
    //
    // View objects:
    //---------------------------------------------------------------
    // | Object         | Event          | Notes          |
    // |----------------|----------------|----------------|
    // |                |                |                |
    //
    //
    // Controller objects:
    //---------------------------------------------------------------
    // | Object         | Event          | Notes          |
    // |----------------|----------------|----------------|
    // |                |                |                |
    //
    //
    // Model objects:
    //---------------------------------------------------------------
    // | Object         | Event          | Notes          |
    // |----------------|----------------|----------------|
    // |                |                |                |
    //

    // Make sure the page is loading before we start
    // ---------------------------------------------

    window.onload = function(){

      (function(){


        // Add some event listeners
        // ------------------------

        window.applicationCache.addEventListener("error", function(e) {
          logDebug("Error fetching manifest: a good chance we are offline");
        });

        window.addEventListener("offline", function(e) {
          logDebug("offline...");
        }, false);

        window.addEventListener("online", function(e) {
          logDebug("online...");
        }, false);


        // Check the application cache
        // --------------------------------------------------------------

        this.checkAppCache = function checkAppCache() {

          var appCache = window.applicationCache,
              status = {};
          
          status[appCache.UNCACHED]    = 'UNCACHED';
          status[appCache.IDLE]        = 'IDLE';
          status[appCache.CHECKING]    = 'CHECKING';
          status[appCache.DOWNLOADING] = 'DOWNLOADING';
          status[appCache.UPDATEREADY] = 'UPDATEREADY';
          status[appCache.OBSOLETE]    = 'OBSOLETE';

 
          if(status[appCache.status]) {
            logDebug(status[appCache.status]);
          } else {
            logDebug('UKNOWN CACHE STATUS');
          }

        };

      }());


      // Some general setup
      // -------------------------------

      var runUnitTest = ( window.location.hash == '#unittest');

      logging.threshold  = logging.debug;
      logDebug('Loading page...');
      logDebug('You are running ' + checkBrowser() + '.');
      logDebug('Running unit tests: ' + runUnitTest);

      if (Modernizr.localstorage) {
        logDebug("window.localStorage is available!");
      } else {
        logDebug("window.localStorage is NOT available!");
      }

      checkAppCache();

      // Setup routing
      // -------------------------------

      // Screen 1
      crossroads.addRoute('route1', function() { 
        var html = $('#template1').html();
        var output = Plates.bind(html, null, null);
        $('#ui').html(output);
        logDebug('logging static route1...');} 
      );
      

       // Screen 2
       crossroads.addRoute('route2', function() {
       var html = $('#template2').html();
        var output = Plates.bind(html, null, null);
        $('#ui').html(output);
        logDebug('logging static route2...');} 
      ); 

     // Screen 3      
      crossroads.addRoute('route3', function() {
        var html = $('#template3').html();
        var output = Plates.bind(html, null, null);
        $('#ui').html(output);
        logDebug('logging static route3...');} 
      ); 
      
      
      // Also log routes that did not match anything (useful for debugging)
      crossroads.bypassed.add(function(request){
        logDebug("A route that wasn't matched:"+request); 
      });


      // Setup hasher
      // -------------------------------

      function parseHash(newHash, oldHash){
        crossroads.parse(newHash); 
      }
      
      // parse initial hash 
      hasher.initialized.add(parseHash);

      // parse hash changes
      hasher.changed.add(parseHash);

      // start listening for history change
      hasher.init();
      
      //update URL fragment generating new history record 
      hasher.setHash('route1');


      // Run In-browser unit tests of the hash has been set to '#unittest'
      // -----------------------------------------------------------------

      if (runUnitTest) {

        test("Validate that the app has loaded ok...", function(){
          
          assert( "testing" == "testing", "Tests are executing and the page has been loaded if this is shown" );
        });

      }     

    } // window.onload

    </script>


    <!-- Give unit test results a little color -->

    <style>
      #results li.pass { color: green; }
      #results li.fail { color: red; }
    </style>


  </body>
</html>